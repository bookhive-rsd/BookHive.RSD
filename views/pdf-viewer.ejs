<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= book.title %> - PDF Viewer - BookHive</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/js/all.min.js"></script>
    <style>
        /* Inter font (optional, if you prefer it over default sans) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #2d3748;
        }
        .pdf-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background-color: #1a202c;
        }
        /* Custom scrollbar for webkit browsers (Chrome, Safari, Edge) */
        .canvas-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .canvas-container::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .canvas-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 5px;
            border: 2px solid #2d3748;
        }
        .canvas-container::-webkit-scrollbar-thumb:hover {
            background-color: #718096;
        }
        .canvas-container {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
            flex-grow: 1;
            overflow: auto;
            background-color: #2d3748;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1.5rem;
        }
        #pdf-canvas {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            background-color: white;
            border-radius: 4px;
            max-width: 100%;
            height: auto;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #cbd5e0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #4a5568;
        }
        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0;
        }
        .toolbar-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem;
            min-width: 2.5rem;
            height: 2.5rem;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            color: #cbd5e0;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            font-size: 1rem;
        }
        .toolbar-button:hover {
            background-color: #4a5568;
            color: #f7fafc;
        }
         .toolbar-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: transparent;
         }
        .page-controls input {
            width: 4rem;
            text-align: center;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #f7fafc;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .page-controls input:focus {
             outline: none;
             border-color: #63b3ed;
             box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
         }
        .page-info {
             padding: 0 0.8rem;
             font-size: 0.9rem;
             color: #a0aec0;
        }
        /* Notes sidebar styles */
        .notes-container {
            position: fixed;
            top: 0;
            right: 0;
            width: 26rem;
            max-width: 90vw;
            height: 100vh;
            background: linear-gradient(180deg, #f7fafc 0%, #edf2f7 100%);
            box-shadow: -6px 0 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            display: flex;
            flex-direction: column;
         }
        .notes-container.show {
            transform: translateX(0);
        }
        .notes-header {
            padding: 1rem;
            border-bottom: 2px solid #cbd5e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
         .notes-header h3 {
             font-weight: 700;
             color: #f7fafc;
             margin: 0;
         }
        .notes-header button {
            color: #f7fafc;
        }
        .notes-area {
            flex-grow: 1;
            padding: 1.2rem;
            overflow-y: auto;
            outline: none;
            background-color: #f7fafc;
        }
        #notesText {
            min-height: 100%;
            font-size: 0.95rem;
            color: #2d3748;
            outline: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        #notesText:empty:before {
            content: attr(placeholder);
            color: #a0aec0;
            pointer-events: none;
        }
        /* Loading Spinner */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
            padding: 2rem;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }
        .loading-spinner.show {
            opacity: 1;
            pointer-events: auto;
        }
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.2);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border-top-color: #63b3ed;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            color: #f7fafc;
            font-size: 0.95rem;
            font-weight: 500;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .toolbar {
                 justify-content: space-around;
                 padding: 0.6rem 0.8rem;
            }
            .toolbar-button {
                padding: 0.5rem;
                min-width: 2.2rem;
                height: 2.2rem;
                font-size: 0.9rem;
            }
            .book-title {
                display: none;
            }
            .notes-container {
                width: 85vw;
            }
            .canvas-container {
                 padding: 0.8rem;
            }
            .page-info {
                font-size: 0.8rem;
            }
        }
        @media (max-width: 480px) {
            .toolbar {
                padding: 0.5rem 0.6rem;
            }
            .toolbar-section {
                gap: 0.2rem;
            }
            .page-controls input {
                width: 3rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="pdf-container bg-gray-600">
        <div id="notesContainer" class="notes-container">
            <div class="notes-header">
                 <h3>My Notes</h3>
                 <button id="closeNotes" class="toolbar-button" style="color: #4b5563;" title="Close Notes"> <i class="fas fa-times"></i>
                 </button>
            </div>
            <div class="notes-area">
                <div id="notesText" contenteditable="true" placeholder="Write your notes here..." spellcheck="false"><%- note %></div>
            </div>
        </div>

        <nav class="main-nav bg-white shadow-sm z-20 relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <a href="/">
                            <img src="/images/logo-removebg-preview.png" alt="BookHive Logo" class="h-16 w-auto">
                            </a>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- <a href="/bookhive" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">BookHive</a> -->
                        <a href="/bookhive" class="nav-link"><i class="fas fa-book"></i> BookHive</a>
                        <!-- <a href="/pinned" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Pinned Books</a> -->
                    </div>
                </div>
            </div>
        </nav>

        <div class="toolbar z-10 relative">
            <div class="toolbar-section">
                <a href="javascript:history.back()" class="toolbar-button" title="Back">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <span class="book-title text-gray-100 font-semibold truncate hidden sm:inline md:hidden"><%= book.title %></span>
            </div>

            <div class="toolbar-section page-controls">
                <button id="prev" class="toolbar-button" title="Previous Page">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="flex items-center">
                    <input type="number" id="pageNumber" value="1" min="1">
                    <span class="page-info">/ <span id="pageCount">0</span></span>
                </div>
                <button id="next" class="toolbar-button" title="Next Page">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="toolbar-section zoom-controls">
                <button id="zoomOut" class="toolbar-button" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="zoomIn" class="toolbar-button" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>

            <div class="toolbar-section audio-controls">
                <button id="toggleRead" class="toolbar-button" title="Read Aloud">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button id="stopRead" class="toolbar-button" title="Stop Reading" disabled>
                    <i class="fas fa-stop"></i>
                </button>
            </div>

            <div class="toolbar-section utility-controls">
                <button id="toggleNotes" class="toolbar-button" title="Toggle Notes">
                    <i class="fas fa-edit"></i>
                </button>
                <button id="toggleFullscreen" class="toolbar-button" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="pdf-canvas"></canvas>
            <div class="loading-spinner" id="loading">
                <div class="spinner"></div>
                <p class="loading-text">Loading PDF...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Notes Sidebar Elements and Logic ---
            const notesContainer = document.getElementById('notesContainer');
            const toggleNotesButton = document.getElementById('toggleNotes');
            const closeNotesButton = document.getElementById('closeNotes');
            const notesText = document.getElementById('notesText');
            let typingTimer;

            toggleNotesButton.addEventListener('click', () => {
                notesContainer.classList.toggle('show');
            });
            closeNotesButton.addEventListener('click', () => {
                notesContainer.classList.remove('show');
            });

            notesText.addEventListener('input', () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(saveNotes, 1000); // Auto-save after 1s inactivity
            });

            async function saveNotes() {
                const content = notesText.innerHTML; // Save HTML content to preserve formatting
                try {
                    const response = await fetch('/notes/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bookId: '<%= book._id %>', content })
                    });
                    if (!response.ok) {
                        const data = await response.json().catch(() => ({ message: 'Unknown error' }));
                        console.error('Failed to save note:', data.message || response.statusText);
                    } else {
                        console.log('Notes saved successfully');
                    }
                } catch (err) {
                    console.error('Error saving note:', err);
                }
            }

            // --- PDF.js Setup ---
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

            let pdfDoc = null;
            let pageNum = 1;
            let pageRendering = false;
            let pageNumPending = null;
            let currentScale = 1.0;
            const initialAutoScale = true;
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('canvasContainer');
            const loading = document.getElementById('loading');
            const pageNumberInput = document.getElementById('pageNumber');
            const pageCountDisplay = document.getElementById('pageCount');
            const prevButton = document.getElementById('prev');
            const nextButton = document.getElementById('next');
            const zoomInButton = document.getElementById('zoomIn');
            const zoomOutButton = document.getElementById('zoomOut');

            // --- Audio Setup ---
            const toggleReadButton = document.getElementById('toggleRead');
            const stopReadButton = document.getElementById('stopRead');
            let speech = new SpeechSynthesisUtterance();
            let isReading = false;
            let currentTextItems = [];
            let currentChunkIndex = 0;
            let currentPageNum = 0; // Track the page for which text is loaded

            speech.lang = 'en-US';
            speech.rate = 1.0;
            speech.volume = 1.0;
            speech.onend = handleSpeechEnd;
            speech.onboundary = handleSpeechBoundary;

            function handleSpeechBoundary(event) {
                if (event.name === 'sentence' && isReading) {
                    currentChunkIndex++;
                }
            }

            function handleSpeechEnd() {
                isReading = false;
                toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                toggleReadButton.title = 'Read Aloud';
                stopReadButton.disabled = true;
                currentChunkIndex = 0; // Reset index when speech ends naturally
            }

            toggleReadButton.addEventListener('click', async () => {
                if (isReading) {
                    window.speechSynthesis.pause();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = false;
                } else {
                    if (window.speechSynthesis.paused) {
                        window.speechSynthesis.resume();
                        isReading = true;
                        toggleReadButton.innerHTML = '<i class="fas fa-pause"></i>';
                        toggleReadButton.title = 'Pause Reading';
                        stopReadButton.disabled = false;
                    } else {
                        await startReading();
                    }
                }
            });

            stopReadButton.addEventListener('click', () => {
                if (isReading || window.speechSynthesis.paused) {
                    window.speechSynthesis.cancel();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = true;
                    currentChunkIndex = 0;
                    currentTextItems = [];
                    currentPageNum = 0;
                }
            });

            async function startReading() {
                if (!pdfDoc) return;
                isReading = true;
                toggleReadButton.innerHTML = '<i class="fas fa-pause"></i>';
                toggleReadButton.title = 'Pause Reading';
                stopReadButton.disabled = false;

                try {
                    // Only fetch text if we're on a new page or text items are empty
                    if (currentPageNum !== pageNum || currentTextItems.length === 0) {
                        const page = await pdfDoc.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        currentTextItems = textContent.items.filter(item => item.str.trim().length > 0);
                        currentPageNum = pageNum;
                        currentChunkIndex = 0; // Reset index for new page
                    }

                    if (currentTextItems.length === 0) {
                        console.log('No text to read on page', pageNum);
                        handleSpeechEnd();
                        return;
                    }

                    // Join text from current chunk index onward
                    const textToRead = currentTextItems.slice(currentChunkIndex).map(item => item.str).join(' ');
                    if (textToRead.length === 0) {
                        console.log('No more text to read from current index on page', pageNum);
                        handleSpeechEnd();
                        return;
                    }

                    speech.text = textToRead;
                    window.speechSynthesis.speak(speech);
                } catch (error) {
                    console.error('Error extracting text for reading:', error);
                    handleSpeechEnd();
                }
            }

            // --- PDF Loading ---
            const pdfUrl = '/file/<%= book._id %>';
            console.log('Loading PDF from:', pdfUrl);
            loading.classList.add('show');

            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            loadingTask.promise.then(function(pdf) {
                console.log('PDF loaded successfully');
                pdfDoc = pdf;
                pageCountDisplay.textContent = pdf.numPages;
                pageNumberInput.max = pdf.numPages;
                updatePageNavControls();
                renderPage(pageNum, initialAutoScale ? null : currentScale);
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                loading.innerHTML = '<p class="text-red-400 font-semibold">Error loading PDF. Please check the file or try again later.</p>';
                loading.classList.add('show');
            });

            // --- PDF Page Rendering (Optimized) ---
            function renderPage(num, scaleToUse = currentScale) {
                if (!pdfDoc) return;
                pageRendering = true;
                loading.classList.add('show');
                canvas.style.opacity = '0.5';

                pdfDoc.getPage(num).then(function(page) {
                    // Optimize for device pixel ratio
                    const Dpr = Math.min(window.devicePixelRatio || 1, 2);
                    const containerPadding = 24;
                    const availableWidth = Math.min(container.clientWidth - containerPadding, 1200);
                    const availableHeight = container.clientHeight - containerPadding;

                    let viewport = page.getViewport({ scale: 1 });

                    let scale;
                    if (scaleToUse === null) {
                        const scaleX = availableWidth / viewport.width;
                        const scaleY = availableHeight / viewport.height;
                        scale = Math.min(scaleX, scaleY, 1.5); // Reduced max scale for better performance
                        currentScale = scale;
                    } else {
                        scale = Math.max(0.25, Math.min(scaleToUse, 3.0)); // Limit scale range
                    }

                    viewport = page.getViewport({ scale: scale * Dpr });

                    // Limit canvas size for memory efficiency
                    const maxCanvasSize = 3000;
                    const scaleFactor = Math.min(1, maxCanvasSize / Math.max(viewport.width, viewport.height));
                    
                    canvas.height = Math.floor(viewport.height * scaleFactor);
                    canvas.width = Math.floor(viewport.width * scaleFactor);
                    canvas.style.height = Math.floor(viewport.height / Dpr) + 'px';
                    canvas.style.width = Math.floor(viewport.width / Dpr) + 'px';

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport,
                        enableWebGL: true
                    };

                    const renderTask = page.render(renderContext);
                    renderTask.promise.then(function() {
                        console.log(`Page ${num} rendered successfully`);
                        pageRendering = false;
                        loading.classList.remove('show');
                        canvas.style.opacity = '1';
                        pageNumberInput.value = num;
                        updatePageNavControls();

                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    }).catch(renderError => {
                        console.error(`Error rendering page ${num}:`, renderError);
                        pageRendering = false;
                        loading.classList.remove('show');
                        canvas.style.opacity = '1';
                    });
                }).catch(pageError => {
                    console.error(`Error getting page ${num}:`, pageError);
                    pageRendering = false;
                    loading.classList.remove('show');
                    canvas.style.opacity = '1';
                });
            }

            function queueRenderPage(num, scale = currentScale) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num, scale);
                }
            }

            function updatePageNavControls() {
                if (!pdfDoc) return;
                prevButton.disabled = (pageNum <= 1);
                nextButton.disabled = (pageNum >= pdfDoc.numPages);
                zoomOutButton.disabled = (currentScale <= 0.25);
                zoomInButton.disabled = (currentScale >= 3.0);
            }

            // --- Page Navigation ---
            function onPrevPage() {
                if (pageNum <= 1) return;
                pageNum--;
                if (isReading || window.speechSynthesis.paused) {
                    window.speechSynthesis.cancel();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = true;
                    currentChunkIndex = 0;
                    currentTextItems = [];
                    currentPageNum = 0;
                }
                queueRenderPage(pageNum);
            }

            function onNextPage() {
                if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
                pageNum++;
                if (isReading || window.speechSynthesis.paused) {
                    window.speechSynthesis.cancel();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = true;
                    currentChunkIndex = 0;
                    currentTextItems = [];
                    currentPageNum = 0;
                }
                queueRenderPage(pageNum);
            }

            prevButton.addEventListener('click', onPrevPage);
            nextButton.addEventListener('click', onNextPage);

            pageNumberInput.addEventListener('change', function() {
                if (!pdfDoc) return;
                let inputVal = parseInt(this.value, 10);
                if (!isNaN(inputVal) && inputVal >= 1 && inputVal <= pdfDoc.numPages) {
                    if (inputVal !== pageNum) {
                        pageNum = inputVal;
                        if (isReading || window.speechSynthesis.paused) {
                            window.speechSynthesis.cancel();
                            isReading = false;
                            toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                            toggleReadButton.title = 'Read Aloud';
                            stopReadButton.disabled = true;
                            currentChunkIndex = 0;
                            currentTextItems = [];
                            currentPageNum = 0;
                        }
                        queueRenderPage(pageNum);
                    }
                } else {
                    this.value = pageNum;
                }
            });

            // --- Zoom Controls ---
            function onZoomIn() {
                if (currentScale >= 5.0) return;
                currentScale = parseFloat((currentScale + 0.1).toFixed(2));
                if (isReading || window.speechSynthesis.paused) {
                    window.speechSynthesis.cancel();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = true;
                    currentChunkIndex = 0;
                    currentTextItems = [];
                    currentPageNum = 0;
                }
                queueRenderPage(pageNum);
            }

            function onZoomOut() {
                if (currentScale <= 0.25) return;
                currentScale = parseFloat((currentScale - 0.1).toFixed(2));
                if (isReading || window.speechSynthesis.paused) {
                    window.speechSynthesis.cancel();
                    isReading = false;
                    toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    toggleReadButton.title = 'Read Aloud';
                    stopReadButton.disabled = true;
                    currentChunkIndex = 0;
                    currentTextItems = [];
                    currentPageNum = 0;
                }
                queueRenderPage(pageNum);
            }

            zoomInButton.addEventListener('click', onZoomIn);
            zoomOutButton.addEventListener('click', onZoomOut);

            // --- Fullscreen ---
            const fullscreenButton = document.getElementById('toggleFullscreen');
            const pdfContainerElement = document.querySelector('.pdf-container');

            fullscreenButton.addEventListener('click', function() {
                toggleFullscreen(pdfContainerElement);
            });

            function toggleFullscreen(element) {
                if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                    if (element.requestFullscreen) {
                        element.requestFullscreen();
                    } else if (element.msRequestFullscreen) {
                        element.msRequestFullscreen();
                    } else if (element.mozRequestFullScreen) {
                        element.mozRequestFullScreen();
                    } else if (element.webkitRequestFullscreen) {
                        element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                }
            }

            function updateFullscreenButtonIcon() {
                const isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                fullscreenButton.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
                fullscreenButton.title = isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen';
                setTimeout(() => queueRenderPage(pageNum), 100);
            }

            document.addEventListener('fullscreenchange', updateFullscreenButtonIcon);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButtonIcon);
            document.addEventListener('mozfullscreenchange', updateFullscreenButtonIcon);
            document.addEventListener('MSFullscreenChange', updateFullscreenButtonIcon);

            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', function(e) {
                if (e.target === notesText || e.target === pageNumberInput) {
                    return;
                }

                let handled = false;
                if (e.key === 'ArrowRight' || e.key === ' ') {
                    onNextPage();
                    handled = true;
                } else if (e.key === 'ArrowLeft') {
                    onPrevPage();
                    handled = true;
                } else if (e.key === '+' || e.key === '=') {
                    onZoomIn();
                    handled = true;
                } else if (e.key === '-') {
                    onZoomOut();
                    handled = true;
                } else if (e.key === 'f') {
                    toggleFullscreen(pdfContainerElement);
                    handled = true;
                } else if (e.key === 'r') { // 'r' for Read Aloud
                    if (isReading) {
                        window.speechSynthesis.pause();
                        isReading = false;
                        toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                        toggleReadButton.title = 'Read Aloud';
                        stopReadButton.disabled = false;
                    } else {
                        if (window.speechSynthesis.paused) {
                            window.speechSynthesis.resume();
                            isReading = true;
                            toggleReadButton.innerHTML = '<i class="fas fa-pause"></i>';
                            toggleReadButton.title = 'Pause Reading';
                            stopReadButton.disabled = false;
                        } else {
                            startReading();
                        }
                    }
                    handled = true;
                } else if (e.key === 's') { // 's' for Stop Reading
                    if (isReading || window.speechSynthesis.paused) {
                        window.speechSynthesis.cancel();
                        isReading = false;
                        toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                        toggleReadButton.title = 'Read Aloud';
                        stopReadButton.disabled = true;
                        currentChunkIndex = 0;
                        currentTextItems = [];
                        currentPageNum = 0;
                    }
                    handled = true;
                }

                if (handled) {
                    e.preventDefault();
                }
            });

            // --- Resize Handler ---
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (pdfDoc) {
                        console.log('Window resized, re-rendering page.');
                        if (isReading || window.speechSynthesis.paused) {
                            window.speechSynthesis.cancel();
                            isReading = false;
                            toggleReadButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                            toggleReadButton.title = 'Read Aloud';
                            stopReadButton.disabled = true;
                            currentChunkIndex = 0;
                            currentTextItems = [];
                            currentPageNum = 0;
                        }
                        queueRenderPage(pageNum, currentScale);
                    }
                }, 250);
            });
        });
    </script>
</body>
</html>