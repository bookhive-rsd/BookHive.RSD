<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/bookhive/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Publications - BookHive</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { background-color: #f3f2ef; }
    .publication-content ul, .publication-content ol { padding-left: 1.5rem; margin-bottom: 1rem; }
    .publication-content a { color: #0a66c2; text-decoration: underline; }
    .action-button { display: inline-flex; align-items: center; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; color: #666666; transition: background-color 0.2s; }
    .action-button:hover { background-color: #e0e0e0; }
    .action-button i { margin-right: 0.5rem; font-size: 1.25rem; }
    .like-button.liked { color: #0a66c2; font-weight: 700; }
    .welcome-text { color: white; font-size: 1.0rem; font-weight: 600; text-shadow: 0 2px 4px rgba(0, 0, 0, 1.5); animation: bouncingText 2s infinite; font-family: 'Poppins', sans-serif; }
    @keyframes bouncingText { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }
    .image-carousel { position: relative; background-color: #f0f2f5; }
    .carousel-image { max-height: 350px; width: 100%; object-fit: contain; }
    .carousel-button { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.4); color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .carousel-button:hover { background-color: rgba(0, 0, 0, 0.6); }
    .carousel-button.prev { left: 0.5rem; }
    .carousel-button.next { right: 0.5rem; }
    .carousel-counter { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; font-weight: bold; }
  </style>
</head>
<body class="font-sans">
  <header class="header">
    <div class="container">
      <div class="logo-section">
        <a href="/"><img src="/images/logo-removebg-preview.png" alt="BookHive Logo" class="logo"></a>
        <a href="/" class="welcome-text">Welcome to BookHive, <%= user.username %></a>
      </div>
      <nav class="nav-menu">
        <a href="/applications" class="nav-link"><i class="fas fa-th"></i> Applications</a>
        <a href="/news" class="nav-link"><i class="fas fa-newspaper"></i> News</a>
        <a href="/publications" class="nav-link active"><i class="fas fa-book-open"></i> Publications</a>
        <a href="/bookhive" class="nav-link"><i class="fas fa-book"></i> BookHive</a>
        <a href="/community" class="nav-link"><i class="fas fa-comments"></i> Community</a>
        <a href="/logout" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto mt-8 px-4 w-[70%]">
    <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Publications</h2>

    <% if (user) { %>
      <section id="publication-form" class="bg-white p-4 rounded-lg border border-gray-300 shadow-sm mb-8">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">Share Your Thoughts</h3>
        <form id="create-publication-form" enctype="multipart/form-data">
          <div id="publication-editor-container" class="mb-4 border rounded-md">
            <div id="publication-editor" class="h-32"></div>
          </div>
          <input type="hidden" id="publication-content" name="content">
          <div class="mb-4">
            <label for="publication-files" class="cursor-pointer text-blue-600 hover:text-blue-800 font-semibold">
              <i class="fas fa-photo-video"></i> Add Images or Documents
            </label>
            <input type="file" id="publication-files" name="files" accept="image/jpeg,image/png,application/pdf" class="hidden" multiple>
          </div>
          <div id="file-previews" class="mt-4 grid grid-cols-3 md:grid-cols-5 gap-4 mb-4"></div>
          <div class="flex items-center justify-end">
            <button type="submit" id="submit-publication" class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-700 disabled:bg-gray-400">Post</button>
          </div>
        </form>
        <div id="publicationError" class="text-red-500 mt-2 hidden"></div>
        <div id="publicationSuccess" class="text-green-500 mt-2 hidden"></div>
      </section>
    <% } %>

    <div id="publications-list" class="space-y-4 w-11/12 mx-auto">
      <% publications.forEach(function(publication) { %>
        <div class="bg-white rounded-lg border border-gray-300 shadow-sm publication-item" data-publication-id="<%= publication._id %>">
          <div class="p-3">
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-gray-600 text-lg mr-2">
                <%= publication.postedBy ? publication.postedBy.username.charAt(0).toUpperCase() : '?' %>
              </div>
              <div>
                <p class="font-semibold text-base text-gray-800"><%= publication.postedBy ? publication.postedBy.username : 'Unknown User' %></p>
                <span class="text-gray-500 text-xs"><%= new Date(publication.createdAt).toLocaleString() %></span>
              </div>
            </div>
            <div class="publication-content text-sm mb-3 text-gray-700"><%- publication.content %></div>
          </div>
          
          <div class="media-container space-y-2">
            <% if (publication.images && publication.images.length > 0) { %>
              <div class="image-carousel" data-total="<%= publication.images.length %>">
                <% publication.images.forEach(function(image, index) { %>
                  <img src="/publication-file/<%= publication._id %>/image/<%= index %>" 
                       alt="Publication Image <%= index + 1 %>"
                       class="carousel-image <%= index === 0 ? 'block' : 'hidden' %>"
                       data-index="<%= index %>">
                <% }) %>
                <% if (publication.images.length > 1) { %>
                  <button class="carousel-button prev"><i class="fas fa-chevron-left"></i></button>
                  <button class="carousel-button next"><i class="fas fa-chevron-right"></i></button>
                  <div class="carousel-counter">1 / <%= publication.images.length %></div>
                <% } %>
              </div>
            <% } %>

            <% if (publication.documents && publication.documents.length > 0) { %>
              <% publication.documents.forEach(function(doc, index) { %>
                <div class="p-3">
                  <p class="font-semibold text-sm mb-2 text-gray-600"><%= doc.filename %></p>
                  <iframe src="/publication-file/<%= publication._id %>/document/<%= index %>" class="w-full h-72 rounded-md border"></iframe>
                </div>
              <% }) %>
            <% } %>
          </div>

          <div class="p-2 border-t border-gray-200">
            <div class="flex items-center justify-around">
              <% const isLiked = user && publication.likes.some(id => id.toString() === user._id.toString()); %>
              <button class="like-button action-button <%= isLiked ? 'liked' : '' %>">
                <i class="far fa-thumbs-up"></i>
                <span class="like-text"><%= isLiked ? 'Liked' : 'Like' %></span>&nbsp;
                (<span class="like-count"><%= publication.likeCount || 0 %></span>)
              </button>
              <button class="comment-toggle action-button">
                <i class="far fa-comment-dots"></i> Comment
              </button>
            </div>
          </div>

          <div class="comment-section bg-gray-50 p-3 border-t border-gray-200 hidden">
            <form class="comment-form flex items-center space-x-2">
              <input name="content" class="w-full p-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add a comment..." required>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-700">Post</button>
            </form>
            <div class="comments-list mt-4 space-y-3">
              <% (comments[publication._id.toString()] || []).forEach(function(comment) { %>
                <div class="comment-item" data-id="<%= comment._id %>">
                  <p class="font-semibold text-sm text-gray-800"><%= comment.user ? comment.user.username : 'Unknown User' %></p>
                  <p class="text-gray-600 text-sm"><%= comment.content %></p>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </main>

  <% if (user) { %><script>window.currentUserId = '<%= user._id %>';</script><% } %>
  <footer>
      <div class="container"><p>Â© 2025 BookHive. All rights reserved.</p></div>
  </footer>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/script.js"></script>
</body>
</html>